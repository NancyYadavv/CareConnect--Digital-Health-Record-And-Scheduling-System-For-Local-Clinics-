<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CareConnect Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
font-family:Arial,sans-serif;
margin:0;
background:url('https://images.unsplash.com/photo-1588776814546-7440aa81839d?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
background-size:cover;
color:#333;
}

/* HERO SECTION (TOP IMAGE) */
.hero{
position:relative;
height:60vh;
background:
linear-gradient(rgba(0,0,0,.55),rgba(0,0,0,.55)),
url('https://images.unsplash.com/photo-1586773860418-d37222d8fce3?auto=format&fit=crop&w=1600&q=80');
background-size:cover;
background-position:center;
display:flex;
align-items:center;
justify-content:center;
text-align:center;
color:white;
}
.hero h1{
font-size:3em;
margin-bottom:10px;
}
.hero p{
font-size:1.2em;
max-width:700px;
}
.hero span{
color:#ffeb3b;
font-weight:bold;
}

/* DARK MODE */
body.dark-mode{
background:#121212 url('https://images.unsplash.com/photo-1588776814546-7440aa81839d?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
background-size:cover;
color:#f5f5f5;
}
body.dark-mode .container{background:rgba(20,20,20,0.9);}
body.dark-mode header{background:rgba(10,60,100,0.9);}
body.dark-mode .card{background:#1e293b;color:#e5e7eb;}
body.dark-mode li{background:#111827;border-left-color:#38bdf8;}
body.dark-mode button{background:#0f766e;}
body.dark-mode button:hover{background:#115e59;}
body.dark-mode footer{background:#020617;}
body.dark-mode .notification{background:#14532d;color:#dcfce7;border-color:#166534;}
body.dark-mode .deleteBtn{background:#b91c1c;}

/* HEADER */
header{
background:rgba(0,119,182,0.85);
color:#fff;
padding:20px;
text-align:center;
box-shadow:0 4px 6px rgba(0,0,0,0.3);
}
header h1{
margin:0;
font-size:2.2em;
text-shadow:2px 2px 4px rgba(0,0,0,0.5);
}
header p{
margin:6px 0 0;
font-size:1em;
}
header a{
color:#ffeb3b;
text-decoration:none;
font-weight:bold;
}

/* DARK MODE TOGGLE BUTTON */
#themeToggle{
position:absolute;
top:20px;
right:20px;
width:auto;
padding:6px 10px;
font-size:0.9em;
}

/* CONTAINER */
.container{
max-width:1100px;
margin:30px auto;
background:rgba(255,255,255,0.85); /* more transparent so background shows */
padding:25px;
border-radius:15px;
box-shadow:0 8px 16px rgba(0,0,0,0.2);
}

input,select,button{
width:100%;
padding:10px;
margin:6px 0;
border-radius:5px;
border:1px solid #ccc;
box-sizing:border-box;
font-size:1em;
}

/* MAIN BUTTONS WITH HOVER EFFECTS */
button{
background:#0077b6;
color:#fff;
border:none;
cursor:pointer;
border-radius:6px;
transition:
background 0.25s ease,
transform 0.18s ease,
box-shadow 0.18s ease,
letter-spacing 0.18s ease;
}
button:hover{
background:#005f86;
transform:translateY(-2px) scale(1.01);
box-shadow:0 6px 14px rgba(0,0,0,0.28);
letter-spacing:0.5px;
}
button:active{
transform:translateY(0) scale(0.99);
box-shadow:0 3px 8px rgba(0,0,0,0.22);
}

/* OPTIONAL: PRIMARY GRADIENT BUTTON */
.btn-primary{
background-image:linear-gradient(120deg,#0ea5e9,#2563eb);
background-size:200% 100%;
transition:
background-position 0.4s ease,
transform 0.18s ease,
box-shadow 0.18s ease;
}
.btn-primary:hover{
background-position:100% 0;
transform:translateY(-2px);
box-shadow:0 8px 18px rgba(37,99,235,0.45);
}

/* GENERAL */
.hidden{display:none;}
h2,h3{color:#0077b6;}
body.dark-mode h2,
body.dark-mode h3{color:#38bdf8;}
ul{list-style:none;padding:0;}

li{
background:#f4f9ff;
padding:12px;
margin:5px 0;
border-left:5px solid #0077b6;
border-radius:5px;
display:flex;
justify-content:space-between;
align-items:center;
}

/* DELETE BUTTON WITH HOVER */
.deleteBtn{
background:red;
color:white;
padding:3px 8px;
border:none;
border-radius:3px;
cursor:pointer;
transition:
background 0.2s ease,
transform 0.15s ease,
box-shadow 0.15s ease;
}
.deleteBtn:hover{
background:#b91c1c;
transform:translateY(-1px);
box-shadow:0 4px 10px rgba(185,28,28,0.45);
}
.deleteBtn:active{
transform:translateY(0);
box-shadow:0 2px 6px rgba(185,28,28,0.35);
}

/* CARDS */
.card{
background:#e0f2ff;
padding:15px;
border-radius:10px;
margin-bottom:15px;
box-shadow:0 4px 8px rgba(0,0,0,0.1);
}
.card:hover{
background:#d0e8ff;
box-shadow:0 6px 12px rgba(0,0,0,0.15);
}

/* NOTIFICATION */
.notification{
background:#d4edda;
color:#155724;
padding:10px;
margin:10px 0;
border-radius:5px;
border:1px solid #c3e6cb;
}

/* WHATSAPP BUTTON */
.whatsapp{
position:fixed;
bottom:20px;
right:20px;
background:#25D366;
color:white;
padding:15px;
border-radius:50%;
font-size:22px;
text-decoration:none;
box-shadow:0 4px 8px rgba(0,0,0,0.3);
z-index:1000;
}

/* FOOTER */
footer{
background:#003049;
color:white;
padding:15px;
text-align:center;
margin-top:30px;
}
</style>
</head>
<body>

<!-- HERO IMAGE TOP SECTION -->
<section class="hero">
<div>
<h1>üè• Welcome to <span>CareConnect</span></h1>
<p>
A smart healthcare management system designed to streamline clinic operations,
improve patient care, and ensure seamless communication between doctors,
patients, and administrators.
</p>
</div>
</section>

<!-- HEADER WITH HELPLINE -->
<header>
<h1>üè• CareConnect Portal</h1>
<p>
üìû Helpline:
<a href="tel:+919876543210">+91 98765 43210</a>
| ‚úâÔ∏è <a href="mailto:support@careconnect.com">support@careconnect.com</a>
</p>
<!-- DARK MODE TOGGLE -->
<button id="themeToggle" onclick="toggleTheme()">üåô Dark mode</button>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginPage" class="card">
<h2>Login</h2>
<select id="role">
<option value="admin">Admin</option>
<option value="doctor">Doctor</option>
<option value="patient">Patient</option>
</select>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p style="color:gray">Admin: <b>admin / 12345</b></p>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDashboard" class="hidden card">
<h2>Admin Dashboard</h2>
<button onclick="showAdmin('patients')">Patients</button>
<button onclick="showAdmin('doctors')">Doctors</button>
<button onclick="showAdmin('appointments')">Appointments</button>
<button onclick="exportAppointmentsCSV()">Export Appointments CSV</button>
<button onclick="logout()">Logout</button>

<!-- Patients -->
<div id="patients" class="hidden card">
<h3>Register / Update Patient</h3>
<input id="pname" placeholder="Name">
<input id="puser" placeholder="Username">
<input id="ppass" type="password" placeholder="Password">
<input id="page" type="number" placeholder="Age">
<input id="pcontact" placeholder="Contact Number">
<input id="phistory" placeholder="Medical History">
<button onclick="addPatient()">Save Patient</button>
<ul id="patientList"></ul>
</div>

<!-- Doctors -->
<div id="doctors" class="hidden card">
<h3>Register / Update Doctor</h3>
<input id="dname" placeholder="Doctor Name">
<input id="duser" placeholder="Username">
<input id="dpass" type="password" placeholder="Password">
<input id="dspecial" placeholder="Specialization">
<input id="dstart" type="time" placeholder="Start Time">
<input id="dend" type="time" placeholder="End Time">
<button onclick="addDoctor()">Save Doctor</button>
<ul id="doctorList"></ul>
</div>

<!-- Appointments -->
<div id="appointments" class="hidden card">
<h3>Schedule Appointment</h3>
<input id="apid" type="number" placeholder="Patient ID">
<select id="adid"></select>
<input id="adate" type="date">
<input id="atime" type="time">
<input id="apurpose" placeholder="Purpose">
<button onclick="addAppointment()">Schedule</button>
<ul id="appointmentList"></ul>
<div id="notification" class="notification hidden"></div>
</div>
</div>

<!-- DOCTOR DASHBOARD -->
<div id="doctorDashboard" class="hidden card">
<h2>Doctor Dashboard</h2>
<button onclick="showDoctor('today')">Today's Appointments</button>
<button onclick="showDoctor('nextWeek')">Next 7 Days</button>
<button onclick="showDoctor('viewPatient')">View Patient</button>
<button onclick="logout()">Logout</button>

<div id="today" class="hidden card">
<h3>Today's Appointments</h3>
<ul id="doctorAppointments"></ul>
</div>
<div id="nextWeek" class="hidden card">
<h3>Next 7 Days Appointments</h3>
<ul id="doctorNextWeekAppointments"></ul>
</div>
<div id="viewPatient" class="hidden card">
<h3>Search Patient</h3>
<p>Enter <b>Patient ID OR Username</b></p>
<input id="searchPatient" placeholder="Patient ID or Username">
<button onclick="doctorFindPatient()">Search</button>
<div id="patientDetails"></div>
</div>
</div>

<!-- PATIENT DASHBOARD -->
<div id="patientDashboard" class="hidden card">
<h2>Patient Dashboard</h2>
<div id="patientProfile"></div>

<!-- PATIENT SELF BOOKING -->
<div class="card">
<h3>Book New Appointment</h3>
<select id="pBookDoctor"></select>
<input id="pBookDate" type="date">
<select id="pBookTime">
<option value="">-- Select time --</option>
</select>
<input id="pBookPurpose" placeholder="Purpose">
<button onclick="patientBookAppointment()">Book Appointment</button>
<div id="pBookMsg" class="notification hidden"></div>
</div>

<h3>My Appointments</h3>
<ul id="myAppointments"></ul>
<div id="appointmentInfo" class="notification hidden"></div>
<button onclick="logout()">Logout</button>
</div>

</div> <!-- end .container -->

<!-- WHATSAPP SUPPORT -->
<a class="whatsapp"
href="https://wa.me/919876543210"
target="_blank"
title="Chat on WhatsApp">
<img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg"
alt="WhatsApp"
style="width:28px;height:28px;display:block;">
</a>

<!-- FOOTER -->
<footer>
<p>
CareConnect Healthcare Center<br>
üìç MG Road, Bengaluru ‚Äì 560001<br>
‚è∞ Working Hours: 9:00 AM ‚Äì 6:00 PM (Mon‚ÄìSat)
</p>
</footer>

<script>
// Helper functions
const getData = k => JSON.parse(localStorage.getItem(k) || '[]');
const setData = (k,v) => localStorage.setItem(k, JSON.stringify(v));

// THEME: load saved preference
(function initTheme(){
const saved = localStorage.getItem('theme');
if(saved === 'dark'){
document.body.classList.add('dark-mode');
const btn = document.getElementById('themeToggle');
if(btn) btn.textContent = '‚òÄÔ∏è Light mode';
}
})();

function toggleTheme(){
document.body.classList.toggle('dark-mode');
const isDark = document.body.classList.contains('dark-mode');
localStorage.setItem('theme', isDark ? 'dark' : 'light');
const btn = document.getElementById('themeToggle');
if(btn) btn.textContent = isDark ? '‚òÄÔ∏è Light mode' : 'üåô Dark mode';
}

// LOGIN
function login(){
const r=role.value,u=username.value,p=password.value;
if(r==='admin' && u==='admin' && p==='12345'){ show('adminDashboard'); renderAdmin(); return; }
if(r==='doctor'){ 
const d=getData('doctors').find(x=>x.username===u && x.password===p);
if(!d) return alert('Invalid doctor login');
localStorage.setItem('doctorId', d.id);
show('doctorDashboard'); loadDoctorToday(); return;
}
if(r==='patient'){
const pt=getData('patients').find(x=>x.username===u && x.password===p);
if(!pt) return alert('Invalid patient login');
localStorage.setItem('patientId', pt.id);
show('patientDashboard'); loadPatient(); preparePatientBooking();
return;
}
alert('Invalid login');
}

// SHOW / LOGOUT
function show(id){
document.querySelectorAll('.container>div').forEach(d=>d.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
}
function logout(){
localStorage.removeItem('doctorId');
localStorage.removeItem('patientId');
show('loginPage');
}

// ADMIN
function showAdmin(id){
document.querySelectorAll('#adminDashboard>div').forEach(d=>d.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
}

// --- PATIENT CRUD ---
let editingPatientId = null;

function addPatient(){
let pts=getData('patients');
if(editingPatientId){
pts = pts.map(p => p.id === editingPatientId ? {
id: editingPatientId,
name: pname.value,
username: puser.value,
password: ppass.value,
age: page.value,
contact: pcontact.value,
history: phistory.value
} : p);
editingPatientId = null;
} else {
pts.push({
id: pts.length ? pts[pts.length-1].id+1 : 1,
name: pname.value,
username: puser.value,
password: ppass.value,
age: page.value,
contact: pcontact.value,
history: phistory.value
});
}
setData('patients', pts);
renderAdmin();
clearPatientForm();
}

function editPatient(id){
const p = getData('patients').find(x=>x.id===id);
if(!p) return;
pname.value=p.name; puser.value=p.username; ppass.value=p.password; page.value=p.age; pcontact.value=p.contact; phistory.value=p.history;
editingPatientId = id;
}

function clearPatientForm(){pname.value=puser.value=ppass.value=page.value=pcontact.value=phistory.value='';}

// --- DOCTOR CRUD ---
let editingDoctorId = null;

function addDoctor(){
let ds=getData('doctors');
if(editingDoctorId){
ds = ds.map(d => d.id === editingDoctorId ? {
id: editingDoctorId,
name: dname.value,
username: duser.value,
password: dpass.value,
special: dspecial.value,
startTime: dstart.value,
endTime: dend.value
} : d);
editingDoctorId = null;
} else {
ds.push({
id: ds.length ? ds[ds.length-1].id+1 : 1,
name: dname.value,
username: duser.value,
password: dpass.value,
special: dspecial.value,
startTime: dstart.value,
endTime: dend.value
});
}
setData('doctors', ds);
renderAdmin();
clearDoctorForm();
}

function editDoctor(id){
const d = getData('doctors').find(x=>x.id===id);
if(!d) return;
dname.value=d.name; duser.value=d.username; dpass.value=d.password; dspecial.value=d.special; dstart.value=d.startTime; dend.value=d.endTime;
editingDoctorId = id;
}

function clearDoctorForm(){dname.value=duser.value=dpass.value=dspecial.value=dstart.value=dend.value='';}

// --- DELETE ---
function deletePatient(id){
if(!confirm('Delete patient?')) return;
let pts=getData('patients').filter(p=>p.id!==id);
setData('patients',pts);
let apts=getData('appointments').filter(a=>a.pid!==id);
setData('appointments',apts);
renderAdmin();
}
function deleteDoctor(id){
if(!confirm('Delete doctor?')) return;
let ds=getData('doctors').filter(d=>d.id!==id);
setData('doctors',ds);
let apts=getData('appointments').filter(a=>a.did!==id);
setData('appointments',apts);
renderAdmin();
}
function deleteAppointment(id){
if(!confirm('Delete appointment?')) return;
let apts=getData('appointments').filter(a=>a.id!==id);
setData('appointments',apts);
renderAdmin();
}

// --- RENDER ---
function renderAdmin(){
patientList.innerHTML=getData('patients').map(p=>`<li>ID ${p.id} - ${p.name} (${p.username}) <button class="deleteBtn" onclick="deletePatient(${p.id})">Delete</button> <button style="margin-left:5px;" onclick="editPatient(${p.id})">Edit</button></li>`).join('');
doctorList.innerHTML=getData('doctors').map(d=>`<li>ID ${d.id} - Dr. ${d.name} (${d.special}) [${d.startTime}-${d.endTime}] <button class="deleteBtn" onclick="deleteDoctor(${d.id})">Delete</button> <button style="margin-left:5px;" onclick="editDoctor(${d.id})">Edit</button></li>`).join('');
appointmentList.innerHTML = getData('appointments').map(a => {
const patient = getData('patients').find(p => p.id === a.pid) || {};
const doctor = getData('doctors').find(d => d.id === a.did) || {};
return `<li>P${a.pid} (${patient.name || 'Unknown'}) ‚Üí D${a.did} (${doctor.name || 'Unknown'}) | ${a.date} ${a.time} | ${a.purpose} 
<button class="deleteBtn" onclick="deleteAppointment(${a.id})">Delete</button>
<button style="margin-left:5px;" onclick="sendReminder(${a.id})">Send Reminder</button>
</li>`;
}).join('');
adid.innerHTML=getData('doctors').map(d=>`<option value="${d.id}">Dr. ${d.name}</option>`).join('');
}

// --- APPOINTMENTS (ADMIN + PATIENT USE COMMON FUNCTION) ---
function createAppointment(pid,did,date,time,purpose){
const patient=getData('patients').find(p=>p.id===pid);
const doctor=getData('doctors').find(d=>d.id===did);
if(!patient || !doctor){ alert('Invalid patient or doctor'); return false; }
if(time<doctor.startTime || time>doctor.endTime){ alert(`Doctor not available at this time. Available: ${doctor.startTime} - ${doctor.endTime}`); return false; }
let existing=getData('appointments').find(a=>a.did===did && a.date===date && a.time===time);
if(existing){ alert('Doctor already has an appointment at this time'); return false; }
let apts=getData('appointments');
apts.push({id:apts.length? apts[apts.length-1].id+1:1,pid,did,date,time,purpose,status:'Pending'});
setData('appointments',apts);
return {patient,doctor};
}

function addAppointment(){
const pid=Number(apid.value), did=Number(adid.value), date=adate.value, time=atime.value, purpose=apurpose.value;
const result = createAppointment(pid,did,date,time,purpose);
if(!result) return;
const {patient,doctor} = result;
renderAdmin();
document.getElementById('notification').classList.remove('hidden');
document.getElementById('notification').innerText=`SMS sent to ${patient.contact}: Your appointment with Dr. ${doctor.name} is confirmed on ${date} at ${time}.`;
if(Number(localStorage.getItem('patientId'))===pid){
document.getElementById('appointmentInfo').classList.remove('hidden');
document.getElementById('appointmentInfo').innerText=`Appointment Confirmed: Dr. ${doctor.name} | ${date} ${time} | Purpose: ${purpose}`;
loadPatient();
}
}

// --- SEND REMINDER ---
function sendReminder(apptId){
const apts = getData('appointments');
const appt = apts.find(a => a.id === apptId);
if(!appt) return alert('Appointment not found');
const patient = getData('patients').find(p => p.id === appt.pid);
const doctor = getData('doctors').find(d => d.id === appt.did);
if(!patient || !doctor) return alert('Invalid patient or doctor');

alert(`Reminder sent to ${patient.name}: Your appointment with Dr. ${doctor.name} is scheduled on ${appt.date} at ${appt.time}`);

document.getElementById('notification').classList.remove('hidden');
document.getElementById('notification').innerText = `Reminder sent to ${patient.contact}: Your appointment with Dr. ${doctor.name} on ${appt.date} at ${appt.time}.`;
}

// --- DOCTOR DASHBOARD ---
function showDoctor(id){
document.querySelectorAll('#doctorDashboard>div').forEach(d=>d.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
if(id==='today') loadDoctorToday();
if(id==='nextWeek') loadDoctorNextWeek();
}
function loadDoctorToday(){
let did=Number(localStorage.getItem('doctorId'));
let today=new Date().toISOString().split('T')[0];
let a=getData('appointments').filter(x=>x.did===did && x.date===today);
doctorAppointments.innerHTML=a.length?a.map(x=>`<li>${x.date} ${x.time} | Patient ID ${x.pid} | ${x.purpose}</li>`).join(''):'<li>No appointments today</li>';
}
function loadDoctorNextWeek(){
let did=Number(localStorage.getItem('doctorId'));
let today=new Date(); today.setHours(0,0,0,0);
let nextWeek=new Date(); nextWeek.setDate(today.getDate()+7);
let a=getData('appointments').filter(x=>x.did===did && new Date(x.date)>=today && new Date(x.date)<=nextWeek);
doctorNextWeekAppointments.innerHTML=a.length?a.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(x=>`<li>${x.date} ${x.time} | Patient ID ${x.pid} | ${x.purpose}</li>`).join(''):'<li>No appointments in the next 7 days</li>';
}
function doctorFindPatient(){
let input=searchPatient.value.trim();
let patients=getData('patients');
let patient=patients.find(p=>p.id===Number(input)||p.username===input);
if(!patient){
patientDetails.innerHTML='<p style="color:red"><b>Patient NOT FOUND</b></p>';
return;
}
patientDetails.innerHTML=`<p><b>${patient.name}</b><br>Patient ID: ${patient.id}<br>Age: ${patient.age}<br>Contact: ${patient.contact}<br>History: ${patient.history}</p>`;
}

// --- PATIENT DASHBOARD ---
function loadPatient(){
let pid=Number(localStorage.getItem('patientId'));
let p=getData('patients').find(x=>x.id===pid);
if(!p) return;
patientProfile.innerHTML=`<p><b>${p.name}</b><br>Patient ID: ${p.id}<br>Age: ${p.age}<br>Contact: ${p.contact}<br>History: ${p.history}</p>`;
let a=getData('appointments').filter(x=>x.pid===pid);
myAppointments.innerHTML=a.length?a.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(x=>`<li>${x.date} ${x.time} | Doctor ${x.did} | ${x.purpose}</li>`).join(''):'<li>No appointments</li>';
}

// --- PATIENT SELF BOOKING ---
function preparePatientBooking(){
const doctors = getData('doctors');
const sel = document.getElementById('pBookDoctor');
if(!sel) return;
sel.innerHTML = '<option value="">-- Select doctor --</option>' +
doctors.map(d=>`<option value="${d.id}">Dr. ${d.name} (${d.special})</option>`).join('');
document.getElementById('pBookDate').value = '';
document.getElementById('pBookTime').innerHTML = '<option value="">-- Select time --</option>';
}

// generate time slots every 30 minutes within doctor's working hours, skipping already booked times
function loadAvailableSlots(){
const did = Number(document.getElementById('pBookDoctor').value);
const date = document.getElementById('pBookDate').value;
const timeSelect = document.getElementById('pBookTime');
timeSelect.innerHTML = '<option value="">-- Select time --</option>';
if(!did || !date) return;

const doctor = getData('doctors').find(d=>d.id===did);
if(!doctor || !doctor.startTime || !doctor.endTime) return;

const appointments = getData('appointments').filter(a=>a.did===did && a.date===date);
const bookedTimes = appointments.map(a=>a.time);

let start = new Date(`2000-01-01T${doctor.startTime}:00`);
let end = new Date(`2000-01-01T${doctor.endTime}:00`);

for(let t = start; t <= end; t.setMinutes(t.getMinutes()+30)){
const hh = String(t.getHours()).padStart(2,'0');
const mm = String(t.getMinutes()).padStart(2,'0');
const ts = `${hh}:${mm}`;
if(ts > doctor.endTime) break;
if(!bookedTimes.includes(ts)){
const opt = document.createElement('option');
opt.value = ts;
opt.textContent = ts;
timeSelect.appendChild(opt);
}
}
}

document.addEventListener('change', function(e){
if(e.target && (e.target.id === 'pBookDoctor' || e.target.id === 'pBookDate')){
loadAvailableSlots();
}
});

function patientBookAppointment(){
const pid = Number(localStorage.getItem('patientId'));
const did = Number(document.getElementById('pBookDoctor').value);
const date = document.getElementById('pBookDate').value;
const time = document.getElementById('pBookTime').value;
const purpose = document.getElementById('pBookPurpose').value.trim();
const msgBox = document.getElementById('pBookMsg');

if(!pid || !did || !date || !time || !purpose){
msgBox.classList.remove('hidden');
msgBox.textContent = 'Please fill all fields.';
return;
}

const result = createAppointment(pid,did,date,time,purpose);
if(!result){
msgBox.classList.remove('hidden');
msgBox.textContent = 'Could not book appointment. Please choose another time.';
return;
}
const {doctor} = result;
msgBox.classList.remove('hidden');
msgBox.textContent = `Appointment booked with Dr. ${doctor.name} on ${date} at ${time}.`;
loadPatient();
loadAvailableSlots();
}

// --- EXPORT APPOINTMENTS AS CSV ---
function exportAppointmentsCSV(){
const apts = getData('appointments');
if(!apts.length){ alert('No appointments to export'); return; }

const patients = getData('patients');
const doctors = getData('doctors');

const header = ['Appointment ID','Patient ID','Patient Name','Doctor ID','Doctor Name','Date','Time','Purpose','Status'];
const rows = apts.map(a=>{
const p = patients.find(x=>x.id===a.pid) || {};
const d = doctors.find(x=>x.id===a.did) || {};
return [
a.id,
a.pid,
p.name || '',
a.did,
d.name || '',
a.date,
a.time,
a.purpose,
a.status || ''
];
});

const csvLines = [header.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))];
const csvStr = csvLines.join('\n');

const blob = new Blob([csvStr], {type:'text/csv;charset=utf-8;'});
const url = URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = 'appointments.csv';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
URL.revokeObjectURL(url);
}

// --- AUTOMATIC REMINDERS ---
function checkReminders(){
const today=new Date();
const patients=getData('patients');
const appointments=getData('appointments');
appointments.forEach(appt=>{
const apptDate=new Date(`${appt.date}T${appt.time}`);
const diffMinutes=(apptDate-today)/60000;
if(diffMinutes>0 && diffMinutes<=60){
const patient=patients.find(p=>p.id===appt.pid);
if(patient){
alert(`Reminder for ${patient.name}: You have an appointment with Doctor ID ${appt.did} at ${appt.date} ${appt.time}`);
}
}
});
}
setInterval(checkReminders,300000); // every 5 minutes
</script>
</body>
</html>

